package orgui

import (
	"fmt"
	"strings"

	"github.com/google/uuid"
	icons "github.com/iota-uz/icons/phosphor"
	"github.com/iota-uz/iota-sdk/components/base"
	"github.com/iota-uz/iota-sdk/components/base/button"
	"github.com/iota-uz/iota-sdk/components/base/input"
	"github.com/iota-uz/iota-sdk/components/multilang"
	"github.com/iota-uz/iota-sdk/modules/org/presentation/viewmodels"
	"github.com/iota-uz/iota-sdk/pkg/composables"
	"github.com/iota-uz/iota-sdk/pkg/crud/models"
)

type NodeFormMode string

const (
	NodeFormCreate NodeFormMode = "create"
	NodeFormEdit   NodeFormMode = "edit"
	NodeFormMove   NodeFormMode = "move"
)

type NodeFormProps struct {
	Mode                 NodeFormMode
	EffectiveDate        string
	Node                 *viewmodels.OrgNodeDetails
	ParentID             *uuid.UUID
	ParentLabel          string
	Errors               map[string]string
	FormError            string
	SearchParentEndpoint string
}

templ NodeForm(props NodeFormProps) {
	{{ pageCtx := composables.UsePageCtx(ctx) }}
	{{ title := "" }}
	{{ action := "" }}
	{{ method := "post" }}
	{{ showCode := false }}
	{{ showParent := false }}
	{{ showMoveParent := false }}
	{{ submitLabel := "" }}
	{{ nodeID := "" }}
	{{ codeValue := "" }}
	{{ nameValue := "" }}
	{{ statusValue := "active" }}
	{{ displayOrderValue := "0" }}
	{{ i18nNamesValue := "" }}
	if props.Node != nil {
		{{ nodeID = props.Node.ID.String() }}
		{{ codeValue = props.Node.Code }}
		{{ nameValue = props.Node.Name }}
		{{ statusValue = props.Node.Status }}
		{{ displayOrderValue = fmt.Sprintf("%d", props.Node.DisplayOrder) }}
		{{ i18nNamesValue = props.Node.I18nNamesJSON }}
	}
	switch props.Mode {
		case NodeFormCreate:
			{{ title = pageCtx.T("Org.UI.Node.CreateTitle") }}
			{{ action = "/org/nodes" }}
			{{ method = "post" }}
			{{ showCode = true }}
			{{ showParent = props.ParentID == nil }}
			{{ submitLabel = pageCtx.T("Org.UI.Actions.Create") }}
		case NodeFormEdit:
			{{ title = pageCtx.T("Org.UI.Node.EditTitle") }}
			{{ action = fmt.Sprintf("/org/nodes/%s", nodeID) }}
			{{ method = "patch" }}
			{{ submitLabel = pageCtx.T("Org.UI.Actions.Save") }}
		case NodeFormMove:
			{{ title = pageCtx.T("Org.UI.Node.MoveTitle") }}
			{{ action = fmt.Sprintf("/org/nodes/%s:move", nodeID) }}
			{{ method = "post" }}
			{{ showMoveParent = true }}
			{{ submitLabel = pageCtx.T("Org.UI.Actions.Move") }}
	}
	<div class="space-y-3">
		<div class="flex items-center justify-between gap-3">
			<div class="text-sm font-semibold text-100">{ title }</div>
			if props.Node != nil && props.Mode != NodeFormCreate {
				@button.Ghost(button.Props{
					Size: button.SizeSM,
					Icon: icons.X(icons.Props{Size: "18"}),
					Attrs: templ.Attributes{
						"hx-get":    fmt.Sprintf("/org/nodes/%s?effective_date=%s", props.Node.ID.String(), props.EffectiveDate),
						"hx-target": "#org-node-panel",
						"hx-swap":   "innerHTML",
					},
				}) {
					{ pageCtx.T("Cancel") }
				}
			}
		</div>
		if props.FormError != "" {
			<div class="rounded-md border border-red-500/40 bg-red-500/10 p-3 text-sm text-red-200">{ props.FormError }</div>
		}
		<form
			class="space-y-3"
			hx-target="#org-node-panel"
			hx-swap="innerHTML"
			if method == "patch" {
				hx-patch={ fmt.Sprintf("%s?effective_date=%s", action, props.EffectiveDate) }
			} else {
				hx-post={ fmt.Sprintf("%s?effective_date=%s", action, props.EffectiveDate) }
			}
		>
			<div>
				<label class="block text-xs font-medium text-200" for="org-node-effective-date">{ pageCtx.T("Org.UI.Shared.EffectiveDate") }</label>
				<input
					id="org-node-effective-date"
					type="date"
					name="effective_date"
					value={ props.EffectiveDate }
					class="mt-1 w-full rounded-md border border-surface-400 bg-surface-100 px-3 py-2 text-sm text-100"
				/>
				<div class="mt-1 text-xs text-400">{ pageCtx.T("Org.UI.Node.EffectiveDate.Help") }</div>
			</div>
			if props.ParentID != nil {
				<input type="hidden" name="parent_id" value={ props.ParentID.String() }/>
				<div class="rounded-md border border-surface-400 bg-surface-300 p-3 text-xs text-200">
					<div class="text-400">{ pageCtx.T("Org.UI.Node.Fields.Parent") }</div>
					<div class="mt-1">
						if strings.TrimSpace(props.ParentLabel) != "" {
							{ strings.TrimSpace(props.ParentLabel) }
						} else {
							<span class="font-mono text-xs">{ props.ParentID.String() }</span>
						}
					</div>
				</div>
			}
			if showCode {
				@input.Text(&input.Props{
					Label: pageCtx.T("Org.UI.Node.Fields.Code"),
					Error: props.Errors["code"],
					Attrs: templ.Attributes{
						"name":  "code",
						"value": codeValue,
					},
				})
			}
			if props.Mode == NodeFormCreate || props.Mode == NodeFormEdit {
				@input.Text(&input.Props{
					Label: pageCtx.T("Org.UI.Node.Fields.Name"),
					Error: props.Errors["name"],
					Attrs: templ.Attributes{
						"name":  "name",
						"value": nameValue,
					},
				})
				@base.Select(&base.SelectProps{
					Label: pageCtx.T("Org.UI.Node.Fields.Status"),
					Error: props.Errors["status"],
					Attrs: templ.Attributes{
						"name": "status",
					},
				}) {
					<option value="active" selected?={ statusValue == "active" }>{ pageCtx.T("Org.UI.Node.Status.Active") }</option>
					<option value="inactive" selected?={ statusValue == "inactive" }>{ pageCtx.T("Org.UI.Node.Status.Inactive") }</option>
				}
				@input.Text(&input.Props{
					Label: pageCtx.T("Org.UI.Node.Fields.DisplayOrder"),
					Error: props.Errors["display_order"],
					Attrs: templ.Attributes{
						"name":  "display_order",
						"type":  "number",
						"value": displayOrderValue,
					},
				})
				{{ ml := models.NewMultiLang("", "", "") }}
				if strings.TrimSpace(i18nNamesValue) != "" {
					{{ parsed, err := models.MultiLangFromString(i18nNamesValue) }}
					if err == nil && parsed != nil {
						{{ ml = parsed }}
					}
				}
				@multilang.FormInputWithJSAndLabelName(ctx, "i18n_names", ml, pageCtx.T("Org.UI.Node.Fields.I18nNames"))
				if strings.TrimSpace(props.Errors["i18n_names"]) != "" {
					<div class="mt-1 text-xs text-red-200">{ props.Errors["i18n_names"] }</div>
				}
			}
			if showParent {
				<div>
					<div data-testid="org-node-parent-combobox">
						@base.Combobox(base.ComboboxProps{
							Searchable:   true,
							Label:        pageCtx.T("Org.UI.Node.Fields.Parent"),
							Name:         "parent_id",
							Endpoint:     props.SearchParentEndpoint,
							Placeholder:  pageCtx.T("Org.UI.Node.Parent.Placeholder"),
							NotFoundText: pageCtx.T("Org.UI.Shared.NotFound"),
						}) {
							<!-- options loaded via HTMX -->
						}
					</div>
					<div class="mt-1 text-xs text-400">{ pageCtx.T("Org.UI.Node.Parent.Help") }</div>
				</div>
			}
			if showMoveParent {
				<div>
					<div data-testid="org-node-new-parent-combobox">
						@base.Combobox(base.ComboboxProps{
							Searchable:   true,
							Label:        pageCtx.T("Org.UI.Node.Fields.NewParent"),
							Name:         "new_parent_id",
							Endpoint:     props.SearchParentEndpoint,
							Placeholder:  pageCtx.T("Org.UI.Node.Parent.Placeholder"),
							NotFoundText: pageCtx.T("Org.UI.Shared.NotFound"),
						}) {
							<!-- options loaded via HTMX -->
						}
					</div>
				</div>
			}
			<div class="flex items-center justify-end gap-2 pt-2">
				@button.Primary(button.Props{
					Size: button.SizeSM,
					Attrs: templ.Attributes{
						"type": "submit",
					},
				}) {
					{ submitLabel }
				}
			</div>
		</form>
	</div>
}
