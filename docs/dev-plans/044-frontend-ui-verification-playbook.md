# DEV-PLAN-044：前端页面可视化验收与交互验证工具链（UI Verification Playbook）

**状态**: 规划中（2025-12-24 00:00 UTC）

> 本文档定位：建立一套“以用户视角为中心”的 UI/交互/功能验证方法与工具链，确保我们不仅依赖后端测试与接口断言，还能通过**真实页面操作**证明可用性与正确性，并把验证证据可复现地沉淀下来（可作为 PR 验收清单与 Readiness 记录的一部分）。

## 1. 背景与上下文 (Context)
- 现状：现有门禁以 lint/test/e2e 为主，能覆盖大量逻辑回归，但对“用户是否真的能顺畅完成操作”“页面是否出现壳套壳/错位 swap/视觉不可读”等可视化与交互问题覆盖不足。
- 风险：仅靠后端/单测/接口测试，容易遗漏：
  - UI 可用性：按钮不可见、输入控件不可读、交互流程不符合心智模型。
  - HTMX/前端状态：错误态 swap 为空、重复 layout 嵌套、push-url 与历史栈异常。
  - 权限/状态组合：某些 capability 未计算导致按钮不出现（典型：页面能力依赖 authz viewstate）。
  - 视觉回归：样式 token 改动导致主题对比度退化。

## 2. 目标与非目标 (Goals & Non-Goals)
### 2.1 核心目标
- [ ] 建立“**用户视角**”验收流程：从页面入口到完成任务的端到端操作路径，覆盖关键交互与错误边界。
- [ ] 建立“**证据可复现**”标准：每个验收项都能产出可追溯的证据（截图/录屏/trace/console/network）。
- [ ] 建立“**工具链组合**”清单：手动 + 半自动（脚本化浏览器）+ 自动化（E2E/视觉回归/可访问性）。
- [ ] 把 UI 验收作为 dev-plan 的一等公民：与 `docs/dev-plans/001-technical-design-template.md` 的“测试与验收标准”对齐。

### 2.2 非目标
- 不在本计划内强制替换现有 E2E 框架或一次性补齐所有页面的视觉回归基线。
- 不在本计划内引入“必须联网/必须第三方 SaaS”的验证服务（如线上录屏平台）；优先本地可复现。

### 2.3 工具链与门禁（SSOT 引用）
> **目的**：避免在 dev-plan 里复制工具链细节导致 drift；本文只声明“命中触发器/推荐本地入口”，命令细节以 `AGENTS.md`/`Makefile`/CI 为准。

- 触发器清单（本计划命中项）：
  - [X] Go 代码（可能会补充测试端点、debug headers、trace hooks）
  - [X] `.templ` / Tailwind（为可测性添加 `data-testid`、修复交互/样式）
  - [X] 文档（新增 playbook 与验收规范）
  - [ ] 多语言 JSON（仅当引入新文案/提示时）
  - [ ] Authz（仅当验证暴露缺口需要补策略/能力计算时）
- SSOT 链接：
  - 触发器矩阵与本地必跑：`AGENTS.md`
  - 命令入口：`Makefile`
  - CI 门禁：`.github/workflows/quality-gates.yml`
  - E2E（Playwright）说明与排障：`e2e/README.md`

## 3. 架构与关键决策 (Architecture & Decisions)
### 3.1 验收分层（建议）
1) **手动 UI 验收（Human-in-the-loop）**：最贴近用户，覆盖“看得见/用得动/流程合理”。
2) **脚本化浏览器验收（Semi-auto）**：复现实操路径并产出证据（trace/录像/截图），减少“口头验收”不可追溯。
3) **自动化 E2E/视觉回归/可访问性（Auto）**：适合高频回归与大范围覆盖，作为防退化门禁。

### 3.2 关键设计决策（ADR 摘要）
- 决策 1：验收证据以“**可复现脚本 + 产物**”为首选
  - 选项 A：只写人工步骤（不选，难追溯、难复现）
  - 选项 B（选定）：人工步骤 + 可选脚本化复现（Playwright trace/录像/截图）
- 决策 2：HTMX/页面交互必须有“可观测性”
  - 选项 A：靠肉眼（不选）
  - 选项 B（选定）：DevTools + 控制台事件 + network/headers（必要时增加 debug header 或 test endpoints）
- 决策 3：可测性优先（Testability-First UI）
  - 选项 A：仅用 CSS selector（不选，容易随样式变更破）
  - 选项 B（选定）：关键交互点补齐稳定锚点（如 `data-testid`、稳定 `id` fragment）

## 4. 工具清单（建议组合）
> 结论先行：当前工具清单已覆盖“手动检查 + 脚本化复现 + 基础 a11y/质量信号”，但对 **设备/viewport 覆盖、可观测性诊断、视觉回归工程化** 的覆盖仍偏薄；其中“故障注入”“性能与稳定性”本阶段暂不开展（见 4.6/4.7）。本章节补齐工具矩阵与“最小集合/增强集合”，避免只列工具名却无法落地。

### 4.0 工具覆盖矩阵（维度 → 工具 → 证据产物）
| 维度 | 主要工具 | 典型证据产物 |
| --- | --- | --- |
| 布局合理性 | DevTools（Elements/Rendering）、截图/录屏 | 首屏与关键区块截图、极端 viewport 录屏 |
| 交互合理性 | DevTools、Playwright（脚本化主路径） | trace/录像、关键步骤截图 |
| HTMX 行为 | Network（HTMX headers）、Console（事件）、Playwright（request/response 断言） | HAR、trace、console 片段 |
| 可访问性 | axe、Lighthouse、键盘-only 手工检查 | a11y 报告、对比度问题截图 |
| 视觉回归 | Playwright 截图 diff（本地）、（可选）第三方对比服务 | diff 截图、基线与变更说明 |
| 性能与体验（暂不开展） | DevTools Performance、Lighthouse、（可选）Web Vitals | 性能报告、关键交互长任务截图 |
| 设备/viewport | Chrome/Chromium（响应式模式）、Playwright（多 viewport） | 各 viewport 关键路径证据 |
| 故障注入（暂不开展） | DevTools Network throttling、离线模式、（可选）代理/Mock | 失败模式复现录屏、错误态截图 |

### 4.1 浏览器与 DevTools（手动验收）
- Chrome/Chromium DevTools：
  - Network：请求链、重定向、缓存、cookie/session、HTMX headers。
  - Console：JS 错误、HTMX 事件、权限/状态计算异常。
  - Performance：交互卡顿、长任务。
  - Rendering/Layers：布局抖动与重排。
- 推荐记录：
  - HAR（网络包）
  - Console log（文本导出）
  - 截图/录屏（关键路径与错误态）

### 4.2 脚本化浏览器（半自动验收）
- Playwright（已落地：复用 `e2e/`）：录屏、trace viewer、截图、下载/上传、表单填充、键盘导航、移动端 viewport。
- 用例策略：
  - “主路径用例”：完成一次核心任务（创建/编辑/查询/切换 effective-date 等）。
  - “边界用例”：权限不足、输入非法、网络失败、并发提交等。

### 4.3 可访问性与可视化质量
- axe / Lighthouse：
  - 对比度、语义结构、可聚焦、ARIA。
- 视觉回归：
  - 截图 diff（可选）：以关键页面与关键组件为基线，避免 token 退化。

### 4.4 可观测性与诊断（建议补齐）
> 目的：把“看起来不对”变成“可定位、可复现、可验证修复”的问题闭环。

- 关联请求与页面动作：发生问题时必须能串联：页面动作 → 网络请求 → 响应片段 → 页面最终 DOM（必要时补充可关联的 request-id）。
- 交互事件证据：Console 能捕捉关键错误（JS error、HTMX 事件链异常）；复杂问题优先用 Playwright trace 作为“可回放的现场”。
- 服务端侧（如需）：以“可复现定位”为目标补齐最小诊断信息（错误码、用户可见提示、日志关联），避免只有 500 与空白页面。

### 4.5 设备与 viewport 覆盖（建议补齐）
- 设备覆盖：至少包含 3 个 viewport（移动/笔记本/大屏），关注“主 CTA 不可触达/弹窗溢出/表格横向滚动不可用”等典型问题。
- 主题与无障碍模式：浅色/深色主题必检；如系统/浏览器提供高对比度模式，建议抽检关键页面。

### 4.6 故障注入与异常路径（暂不开展）
> 暂不开展：本阶段以 Chrome/Chromium 基准的功能/交互可用性为先；故障注入验证先作为后续增强项保留。

### 4.7 性能与稳定性信号（暂不开展）
> 暂不开展：性能与稳定性采样先不纳入本计划门槛，后续按需要补齐。

### 4.8 最小集合 vs 增强集合（落地建议）
- 最小集合（MVP）：DevTools（HAR/Console/录屏）+ Playwright（trace/截图）+ axe（a11y 问题定位）。
- 增强集合：多 viewport 抽检 + 截图 diff 基线。
- 后续增强项（暂不开展）：故障注入（弱网/离线）+ Performance 采样。

## 5. 标准验收流程（面向 PR）
> 目标：任何“影响 UI/交互”的 PR，都能用同一套流程给出明确结论。

### 5.1 入口与准备
- 确认服务启动（见 `devhub.yml` 的 `server`/`postgres`/`templ`/`css`）。
- 使用真实账号登录（或使用 testkit 提供的安全测试账号/seed）。
- 确认租户域名与 cookie 策略正确（必要时使用 `localhost`/primary domain）。

### 5.2 验收维度清单（必须覆盖）
1) **可达性**：入口可访问，路由与权限提示可理解（未授权不可“静默失败”）。
2) **可读性**：关键文本/控件在浅色/深色主题下可读（对比度达标）。
3) **可操作性**：
   - 鼠标：点击/拖拽/打开对话框/提交
   - 键盘：Tab 顺序、Enter/Esc、焦点不丢失
4) **状态与反馈**：loading、success、error、empty state 语义清晰，且不会 swap 成“空白/碎片”。
5) **一致性**：同一能力在不同入口（例如 Org ↔ Person）语义一致、互链一致。
6) **可观测性**：遇到问题能快速定位（console/network/trace 有证据）。

### 5.3 HTMX/局部更新专项检查（如果页面使用 HTMX）
- 验证 `hx-select`/`hx-target` 是否只替换预期 fragment，避免 layout 嵌套。
- 验证错误态（4xx/5xx）仍能渲染到可见区域，且用户能恢复操作。
- 验证 `hx-push-url` 与 back/forward 行为一致。

### 5.4 权限与 capability 专项检查
- 验证按钮/入口的显示逻辑与真实策略一致：
  - 不应因 capability 未计算而“误隐藏”
  - 不应因 capability 误标记而“误放行”
- 验证 forbidden 页面提示具备可操作的下一步（申请权限/联系管理员/返回）。

## 6. 证据与记录（Readiness 产物）
> 交付标准：验收不是“我看过了”，而是“我能证明”。

- 最小证据集（每个关键页面/流程至少一项）：
  - 截图：入口页 + 成功态 + 失败态（可选）
  - trace/录像：主路径（可选但推荐）
  - HAR：关键交互过程（可选）
  - console/network 片段：异常时必须提供
- Playwright 产物（推荐复用）：`e2e/playwright-report/`、`e2e/test-results/`（CI 会上传为 artifact，可在 PR/Readiness 里引用）。
- 记录位置（建议）：
  - 变更对应 dev-plan 的“验证记录（可复现）”章节
  - 或 `docs/dev-records/DEV-PLAN-044-READINESS.md`（如需要正式 readiness 归档）
  - 说明：证据产物通常不入库；优先使用 CI artifact / PR 附件沉淀证据与链接。

## 7. 实施里程碑 (Milestones)
1. [ ] 复用现有 Playwright（`e2e/`）并定义最小 smoke（登录 + 关键页面主路径）。
2. [ ] 为核心页面补齐稳定锚点（`id` fragment / `data-testid`），并形成约定。
3. [ ] 增加 a11y/对比度的自动化检查（可选门禁，或至少在 PR 模板中强制人工检查）。
4. [ ] 落地“多 viewport 抽检”约定：关键主路径覆盖移动/笔记本/大屏并留证据。
5. [ ]（暂不开展）补齐“故障注入”验收项：弱网/离线至少覆盖 1 条关键路径并留证据。
6. [ ] 建立“PR 验收清单”模板：UI 变更必须填写并附证据链接/产物。
7. [ ] 在 1-2 个代表性模块（例如 Org/Person）跑通闭环并复用到其他模块。

## 8. 测试与验收标准 (Acceptance Criteria)
> 本章节在“可用/可见/可操作”的基础上，补齐“页面布局合理性 / 交互操作合理性”的行业最佳实践评估要求，并明确必须输出的分析与优化建议。

### 8.1 行业最佳实践参考（评估基线）
- Nielsen 10 Usability Heuristics：用于交互合理性与错误恢复评估。
- WCAG 2.2 AA（以可读性/键盘可操作/焦点管理为最低门槛）：用于 a11y 与对比度基线。
- 表单与关键动作最佳实践（通用）：清晰标签/就近校验/提交反馈/可逆操作（必要时二次确认）。
- 组件与布局一致性（系统级）：同类页面信息架构一致、主要动作位置稳定、视觉层级明确。

### 8.2 页面布局合理性（评估与验收）
- [ ] **信息架构**：用户一眼可分辨“页面目的 / 当前对象 / 下一步动作”（标题、面包屑、空状态与主 CTA 语义清晰）。
- [ ] **视觉层级**：主次信息层级稳定（标题/区块/字段/帮助文案），关键内容不被装饰性元素抢占注意力。
- [ ] **对齐与节奏**：使用一致的栅格/间距/分组原则；避免同页多套 spacing/token 混用导致的“视觉噪声”。
- [ ] **密度与可扫读**：长表单/长列表可扫读（分段/锚点/折叠/搜索/过滤）；关键信息在首屏可达或有明显导航提示。
- [ ] **响应式与极端尺寸**：至少验证 3 个 viewport（移动/笔记本/大屏）；不出现遮挡、溢出、不可触达主按钮。
- [ ] **状态版式**：loading/empty/error/success 的版式不破坏主布局，不出现“内容跳变导致误操作”。

### 8.3 交互操作合理性（评估与验收）
- [ ] **可发现性**：关键动作可被预期地找到（入口、按钮命名、图标含义一致），不会依赖“只有老司机才懂”的隐性操作。
- [ ] **反馈与确定性**：提交/跳转/局部更新具备明确反馈（loading、成功提示、错误提示、禁用重复提交），用户知道“系统正在做什么”。
- [ ] **错误预防与恢复**：非法输入/权限不足/网络失败有可理解提示，且提供可执行下一步（修改输入、重试、返回、联系管理员等）。
- [ ] **一致性与心智模型**：同类动作跨页面一致（例如保存/取消位置、二次确认策略、列表行操作）；不出现同名按钮含义不同。
- [ ] **可逆性**：破坏性操作（删除/禁用/批量变更）有防误触（确认/撤销/软删除策略其一）；避免不可逆的一键动作。
- [ ] **键盘与焦点管理**：Tab 顺序合理；对话框打开后焦点进入，对话框关闭后焦点返回触发点；HTMX swap 不造成焦点丢失与“跳焦”。
- [ ] **HTMX 专项**（如适用）：无“壳套壳”；错误态（4xx/5xx）不把 target swap 成不可恢复空白；`hx-push-url` 与历史栈行为符合预期。

### 8.4 评估输出物（必须交付）
- [ ] **页面评估报告（每个被评估页面一份）**：包含
  - 入口与用户路径（主路径 + 关键边界）
  - 布局问题清单（按严重度 P0/P1/P2）+ 复现步骤 + 截图/录屏/trace
  - 交互问题清单（按严重度 P0/P1/P2）+ 复现步骤 + 证据
  - 优化建议：短期可修（本 PR/本迭代）与中长期演进（组件/IA/信息结构调整）
- [ ] **可复现证据**：关键路径至少提供截图；出现争议/复杂交互时提供 trace/录像/HAR 其一。
- [ ] **自动化辅助信号（可选但推荐）**：axe/Lighthouse 输出（至少在发现可访问性问题时提供）。
- 严重度口径（建议）：
  - P0：阻断主路径 / 造成数据错误 / 权限绕过 / 页面不可操作或不可恢复空白。
  - P1：不阻断但显著影响效率与理解（交互不一致、反馈不清、错误恢复困难）。
  - P2：轻微视觉/文案/对齐问题，不影响主路径完成。
- 合并口径（建议）：
  - P0：必须在本 PR 修复后再合并。
  - P1：允许合并需同步给出 follow-up（Issue/计划条目）与风险说明。
  - P2：记录并按模块节奏排期修复。

### 8.5 最小通过门槛（本计划完成定义）
- [ ] 至少覆盖 3 条真实用户路径（创建/编辑/查询或切换 as-of），并能通过页面完成且证据可复现。
- [ ] 至少覆盖 6 个常见失败模式（非法输入、权限不足、空数据、网络失败、并发提交、HTMX swap 错位）。
- [ ] 至少选择 3 个代表性页面完成“布局合理性 + 交互合理性”评估，并产出对应页面评估报告与优化建议。
- [ ] 对 HTMX 页面：证明不存在“壳套壳”，且 4xx 错误不会把 target 区域 swap 成不可恢复状态。
- [ ] 对权限：证明 capability 计算完整（按钮展示与策略一致）。
- [ ] 文档可执行：新人按文档能复现同一套验收并得到同一结论。

## 9. 风险与缓解 (Risks & Mitigations)
- 风险：纯人工验收不可追溯、不可复现
  - 缓解：强制证据产物（trace/录像/截图/har）与脚本化复现
- 风险：选择器脆弱导致 UI 自动化不稳定
  - 缓解：优先 `data-testid`/稳定 `id` fragment
- 风险：环境差异（租户域名/cookie/seed）导致无法稳定登录与造数
  - 缓解：明确 primary domain、提供 testkit/seed 的标准入口（如需补充将另开 dev-plan）
- 风险：证据产物包含敏感信息（cookie、租户数据、个人信息）
  - 缓解：PR/Readiness 提供证据前先做脱敏；避免在公共渠道粘贴完整 HAR/cookie。
