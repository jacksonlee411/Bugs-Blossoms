# DEV-PLAN-059：Position 交付收口（Readiness / 回滚 / 可观测性）（对齐 051 收口）

**状态**: 草拟中（2025-12-20 01:46 UTC）

## 1. 背景
- Position Management 涉及有效期治理、强校验与权限边界；上线风险主要来自：存量链路兼容（System Position）、不可逆迁移、越权能力、以及口径漂移导致的数据一致性问题。
- 本计划负责把 052-058 的交付“收口成可上线的整体”：readiness 记录、回滚/灰度开关、可观测性与最小冒烟验证闭环。

## 2. 工具链与门禁（SSOT 引用）
- 门禁与命令：以 `AGENTS.md`、`Makefile`、`.github/workflows/quality-gates.yml` 为准。
- Org/API/Authz/Outbox/时间线口径：以 051 §3 及其引用的 SSOT 文档为准。

## 3. 目标（完成标准）
- [ ] readiness 可复现：关键门禁命令、结果与时间戳有记录，reviewer 可复跑。
- [ ] 可回滚：关键写入口与强校验具备灰度/禁写/只读等最小回退路径，并明确不可逆点。
- [ ] 可观测：关键操作（Correct/Rescind/冻结窗口拒绝/超编阻断/冲突拒绝）可通过结构化日志 + 审计追溯定位。

## 4. 依赖与并行
- 依赖：`DEV-PLAN-053/054/055/056/057` 的核心交付。
- 可并行：可观测性埋点与回滚开关设计可提前进行，但 readiness 记录与最终冒烟需在功能联调后完成。

## 5. 实施步骤
1. [ ] readiness 记录机制落地
   - 新增 Position 相关 readiness 记录文档（文件名与归档口径需与团队约定一致），记录关键门禁命令/结果/时间戳。
   - 明确“哪些门禁必须记录、哪些可选”，并对齐 CI 的质量门禁口径。
2. [ ] 回滚策略与灰度开关
   - schema：明确不可逆点；对可逆项提供 down/回退路径或兼容期策略。
   - 写入口：提供最小可回退路径（feature flag、只读模式、禁写策略），并明确“数据不可逆”点（例如历史版本变更的审计不可删除）。
3. [ ] 兼容性策略回归
   - System/Managed：确保 System Position 的既有链路不被强校验阻断；Managed 逐步启用强校验。
   - 状态/口径映射：对齐 052 冻结口径，避免 UI/API/统计口径不一致。
4. [ ] 可观测性收口
   - 结构化日志：关键拒绝路径与关键命令（Correct/Rescind/ShiftBoundary）必须可检索。
   - 审计可追溯：从 UI/API 能定位到审计记录与 reason code；必要时提供运维排障入口。
5. [ ] 最小冒烟与演示脚本（执行时填写）
   - 选择最小“可演示闭环”：创建 Position → 占用/释放 FTE → Update/Correct → 时间线查询 → 统计查询。
   - 执行并记录：环境要素（DB/tenant）、命令、结果与时间戳。

## 6. 交付物
- readiness 记录（可复现的门禁与冒烟结果）。
- 回滚/灰度/兼容策略与明确的不可逆点清单。
- 可观测性清单与落地项（日志/审计/排障入口）。

