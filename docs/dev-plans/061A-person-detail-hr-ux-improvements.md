# DEV-PLAN-061A：Person（人员）详情页对齐 HR 操作习惯（IA + 交互 + 可读性）

**状态**: 待合并（本地门禁通过；2025-12-23 18:52 UTC）

## 1. 背景与上下文 (Context)
- **现状**：
  - 人员详情页信息密度偏低，仅展示少量字段；任职经历列表中关键列以 UUID 直出（组织节点/职位）。
  - 状态与日期口径不符合中文 HR 习惯（如 `active`、`9999-12-31`）。
  - 未授权访问时显示“Permission required”技术页（policy diff / inspector 等），对业务用户理解与下一步动作不友好。
- **证据（截图）**：
  - 创建人员页：`docs/assets/dev-plan-061a/person-create.png`
  - 人员详情页（已分配）：`docs/assets/dev-plan-061a/person-detail-bbf780b6.png`
  - 人员详情页（引导补齐任职）：`docs/assets/dev-plan-061a/person-detail-bbf780b6-step-assignment.png`
  - 人员详情页（完成“房地产/职位”分配后的示例）：`docs/assets/dev-plan-061a/person-detail-bbf780b6-after-assignment.png`
- **业务价值**：提升 HR 处理人员主数据与任职记录的效率与可用性，降低误操作与学习成本。

## 2. 目标与非目标 (Goals & Non-Goals)
### 2.1 目标
- [x] 人员详情页按 HR 认知组织信息：可快速识别“人是谁/在哪/做什么/当前是否在职/关键日期”。
- [x] 任职经历列表以“名称/编码”呈现组织与职位（UUID 仅在“复制/更多”里可见）。
- [x] 状态与日期口径本地化：状态使用中文业务口径，开放区间日期展示为“至今/长期”。
- [ ]（后续）操作入口对齐 HR 高频动作：新增任职、发起调动、结束任职、更正有效期、查看变更记录。
- [x] 创建人员流程补齐“初始部门/职位”：创建时可选择（或创建后强引导补齐）部门（组织）与职位。
- [x] 未授权页对业务用户可理解：默认仅给出“无权限 + 申请/联系管理员 + 进度”，调试信息仅对管理员/Debug 开关可见。

### 2.2 非目标
- 不在本计划内引入完整的合同/薪酬/考勤/审批工作流（如需，另起 dev-plan）。
- 不在本计划内一次性补齐所有人员主数据字段（按 HR 高频字段分阶段落地）。

## 2.3 工具链与门禁（SSOT 引用）
> 本节只声明本计划命中哪些触发器；命令细节以 `AGENTS.md` / `Makefile` / CI 为准。

- **触发器清单（本计划预期命中）**：
  - [x] Go 代码（服务端 DTO/查询/mapper 变更）
  - [x] `.templ` / Tailwind（页面结构与组件调整）
  - [x] 多语言 JSON（状态/标签本地化）
  - [x] Authz（“无权限页”展示策略）

- **SSOT 链接**：
  - 触发器矩阵与本地必跑：`AGENTS.md`
  - 命令入口：`Makefile`
  - CI 门禁：`.github/workflows/quality-gates.yml`

## 3. 交互与信息架构（拟定）
### 3.0 术语约定（避免 UI/数据口径混淆）
- **部门（UI 术语）**：在 UI 中对 HR 展示为“部门”，对应系统的 **组织节点（OrgNode）**。
- **组织节点（系统术语）**：数据层与接口参数使用 `org_node_id`（UUID），展示层使用“部门名称（部门编码）”。
- **职位（统一术语）**：本项目统一使用“职位”，对应 `position_id`（UUID）；展示层使用“职位编码 — 职位名称”。

### 3.0A 基于 HR 习惯的“现状不符点”与改进（本计划）
> 以 `docs/assets/dev-plan-061a/` 下截图为依据，总结对 HR 常见操作习惯的不匹配点与已落地改进。

1) **创建人员无法当场完成“部门/职位”闭环**
   - 不符点：新建页只填“工号/姓名”，HR 通常期望“人-部门-职位”一次录入完成，至少要有“下一步必做”的强引导。
   - 已落地：创建成功重定向到详情页 `?step=assignment` 并自动加载“任职创建表单”，减少遗漏。

2) **职位选择依赖手工 UUID，不符合业务用户输入习惯**
   - 不符点：业务用户难以理解/粘贴 UUID；职位应在“已选部门”范围内可搜索选择。
   - 已落地：职位改为 Combobox，并按“部门 + 生效日 + lifecycle=active”过滤；未选部门时禁用职位输入并提示。

3) **详情页直出长 UUID，可读性差且误用风险高**
   - 不符点：HR 需要的是姓名/工号/部门/职位，不需要在主视图阅读 UUID。
   - 已落地：人员 UUID 主视图改为短显示（可复制）；部门/职位在时间线与概览使用 label（名称/编码）。

4) **时间线空态文案不贴合“已在某人员上下文”**
   - 不符点：在人员详情页里再提示“请输入 pernr …”会造成困惑。
   - 已落地：当 `pernr` 已确定时，空态文案改为“暂无任职记录/No assignment timeline yet”。

5) **创建任职后的 URL/上下文跳转不符合预期**
   - 不符点：在人员详情页创建任职后，不应把 URL 推到 `/org/assignments?...`。
   - 已落地：`include_summary=1`（人员详情场景）下使用 `HX-Replace-Url` 清理 `step=assignment`，不 push 到 Org 页面。

### 3.1 页面骨架（信息优先级）
- **顶部（面包屑 + 人员标识）**：`人员 / {姓名（工号）}`，提供“返回列表（保留筛选）”。
- **概览卡（两列或三列）**：
  - 主要字段：姓名、工号（Pernr）、当前状态（徽标）、当前组织、当前职位、入职/离职日期（如适用）。
  - 次要字段：人员 UUID（可复制但默认弱化）、联系方式（如有）。
  - 快捷操作：新增任职/调动/结束任职（按权限显示）。
  - **当前组织/当前职位口径**：以 `effective_date = 今天` 的**主任职（primary）**切片为准；若不存在任何任职记录，则显示“未分配”，并强引导补齐初始任职。

### 3.2 主体 Tabs（建议）
- `概览`：只放高频摘要（避免“稀疏大空白”）。
- `任职记录`（UI 标题可继续用“任职经历”）：列表 + 时间线视图切换（可后续）。
- `用工/合同`（占位，后续计划补齐）。
- `联系信息`（占位，后续计划补齐）。
- `变更记录`：展示关键字段变更与操作人（如已有审计/日志能力可复用）。

### 3.3 任职记录列表（表格可读性与动作）
- 列建议：`组织（名称）`、`职位（名称）`、`生效日期`、`结束日期（至今）`、`用工属性（如有）`、`操作`。
- UUID 处理：表格主视图禁止直出 UUID；在行内“更多/复制 ID”里提供。
- 结束日期口径：`9999-12-31` 等开放区间显示为“至今/长期”。
- 操作：表头主按钮（新增/调动），行内次按钮（编辑/结束/查看）。

### 3.4 创建人员：初始部门/职位缺失（需补齐）
- **已验证问题**：`/person/persons/new` 当前仅包含“工号（Pernr）/姓名”两个输入，没有部门（组织）与职位选择，导致 HR 无法在创建时完成“人-职位-组织”闭环。
- **建议交互（优先级从高到低）**：
  1) 两步向导（推荐）：步骤 1 创建人员成功后，页面内直接进入步骤 2“创建初始任职”（复用 `/org/assignments/form` 相关 UI），并在未完成前给出强提示。
  2) 单页提交：同一表单内包含“初始任职”字段，后端按事务顺序创建 Person + Assignment（失败需可回滚/可补偿）。
  3) 最低保底：创建后重定向到人员详情页时自动展开“创建任职”入口，并提示“请先选择部门与职位”。
- **验收标准**：
  - 创建完成后，用户能立即看到当前部门与职位（名称而非 UUID）。
  - 未建立任何任职记录时，详情页有明显的“补齐初始任职”引导，不允许静默留空。

### 3.5 任职维护：部门/职位选择与可编辑性（需优化）
- **已验证问题（以 061001 为例）**：
  - 在“人员分配/任职维护”表单中，部门（组织节点）可搜索选择，但职位目前是“职位 ID（可选）”的纯文本输入，需要手工粘贴 UUID，无法在 UI 内按部门筛选可用职位。
  - 变更生效后，会生成新的任职记录切片（旧切片结束日被截断到生效日），但在 `effective_date = 当天` 的视图下，新切片因为“可编辑”判定使用 `asOf.After(effectiveDate)` 导致 **当天生效的切片不可编辑**（操作列显示 `-`），不符合 HR 当天更正/补录的常见场景。
- **建议交互**：
  - 职位选择改为 Combobox：默认按“已选部门 + 生效日 + 生命周期=active”过滤，并在候选项中显示 `职位编码 — 职位名称`（可附带占编状态/可用 FTE）。
  - 级联联动：
    - 先选部门再选职位：职位列表自动过滤；
    - 或先选职位：自动回填/锁定部门（以职位所属组织为准），并给出“来源提示”。
  - 生效日显式化：在任职表单内展示并允许修改“生效日期”（默认今日），同时在提交前明确提示“将会截断上一条任职记录的结束日到生效日”。
  - 可编辑性规则调整：允许 `asOf == effectiveDate` 的切片进行编辑（包含当天生效的记录）。

- **验收标准**：
  - 选择部门后，职位候选项仅来自该部门在生效日“启用（active）”的职位（必要时可加 `占编=空缺` 过滤开关）。
  - 职位选择无需手工粘贴 UUID（UI 可搜索/可选）。
  - 在 `effective_date = 当天` 的视图下，当天生效的新切片仍可继续编辑/更正（操作列显示可用的“编辑”入口）。

### 3.6 数据与接口要求（避免 UI 直出 UUID）
- **详情页（概览卡）所需数据**：
  - 当前组织：`org_node_id` + `org_node_label = {name} ({code})`（或至少 `{name}`）。
  - 当前职位：`position_id` + `position_label = {code} — {title}`（或至少 `{code}`）。
- **任职记录列表/时间线所需数据（每行）**：
  - `effective_date` / `end_date`（开放区间 UI 显示“至今/长期”）。
  - `org_node_label`（禁止仅展示 UUID）。
  - `position_label`（禁止仅展示 UUID；允许附带 `position_code` 与 `title`）。
- **依赖与实现提示（不复制实现细节）**：
  - 组织节点可读信息可复用 Org 侧已存在的 label 生成逻辑（例如通过节点详情查询得到 `name/code`）。
  - 职位可读信息建议通过 Org 的 Positions 能力补齐（`position_id -> code/title`），避免 Person 模块自行维护冗余表。
- **职位候选项接口契约（用于 Combobox）**：
  - 建议扩展现有 `/org/positions/search` 支持可选过滤参数：
    - 必填：`effective_date=YYYY-MM-DD`
    - 可选：`org_node_id=<uuid>`（按部门过滤）、`lifecycle_status=active`（默认 active）、`staffing_state=empty`（可选）、`q=<keyword>`
  - 返回：HTML `<option value=\"{position_id}\">{position_code} — {title}</option>` 列表（兼容 `components/base/combobox` 的加载方式）。

## 4. 架构与关键决策 (Architecture & Decisions)
### 4.1 边界与依赖
- **Person 模块（主）**：负责人员列表/详情与“初始任职引导”。
- **Org 模块（依赖）**：任职记录（assignments）与职位（positions）为 SSOT；Person 仅消费其“可读 label”与候选项搜索能力。
- **约束**：避免在 Person 侧复制/持久化组织与职位名称；以查询/聚合方式展示，减少数据漂移。

### 4.2 关键决策（含备选）
- **决策 A（已选）**：创建人员采用“两步向导”
  - Step 1：创建 Person；
  - Step 2：立刻补齐“初始任职”（部门+职位+生效日），未完成前强提示。
  - 原因：符合 HR 流程（人→任职），并复用 Org 任职表单能力，降低一次性契约复杂度。
- **备选（未选）**：单页提交（Person + Assignment 同事务）
  - 风险：跨模块事务/补偿策略复杂；错误提示与重试路径更难做对。

## 5. 数据模型与约束 (Data Model & Constraints)
> 本计划不新增持久化模型；主要是展示聚合与 UI 口径。

### 5.1 展示口径（必须一致）
- **开放区间结束日**：`9999-12-31`（或等价最大值）在 UI 显示为“至今/长期”，但传输与落库保持原值。
- **当前组织/当前职位**：见 `3.1` 的口径定义，确保详情卡与时间线一致。

## 6. 接口契约 (API/HTMX Contracts)
### 6.1 Person 详情页：任职时间线加载（现有 + 展示增强）
- **请求**：`GET /org/assignments?effective_date=YYYY-MM-DD&pernr={pernr}&include_summary=1`（HTMX on load）
- **响应（HTML）**：时间线表格行需包含 `org_node_label` / `position_label`（禁止仅 UUID）；并应用“至今/长期”显示规则。
- **可编辑性规则**：
  - 当前实现使用 `asOf.After(row.EffectiveDate)`；本计划要求 `asOf >= row.EffectiveDate`（当天可编辑），且 `asOf < row.EndDate`。

### 6.2 任职表单：职位候选项搜索（拟新增/扩展）
- **请求**：`GET /org/positions/search?effective_date=YYYY-MM-DD&org_node_id=<uuid>&lifecycle_status=active&staffing_state=empty&q=<keyword>`
  - `org_node_id`：当用户已选择部门时必传；未选择时可不传（返回空或提示先选部门）。
  - `lifecycle_status`：默认 `active`。
  - `staffing_state`：可选（默认不过滤；如提供则用于“空缺/已占编”等场景）。
- **响应（HTML options）**：
  - `<option value="{position_id}">{position_code} — {title}</option>`
  - 若无结果：返回空 options，UI 使用 `NotFoundText` 呈现“未找到”。

### 6.3 创建人员向导（拟定 HTMX 行为）
- **Step 1（创建人员）**：
  - `POST /person/persons`（现有）
  - **成功**：重定向到 `GET /person/persons/{person_uuid}?step=assignment`（新增 query 仅用于 UI 控制，不改变资源语义）
- **Step 2（补齐初始任职）**：
  - 复用 Org 任职表单：`GET /org/assignments/form?effective_date=YYYY-MM-DD&pernr={pernr}`
  - **成功**：时间线 OOB 更新 + 详情页概览卡同步展示“当前组织/当前职位”。
  - **失败**：表单内展示字段错误与 request_id（如存在）。

## 7. 权限、文案与可用性
### 7.1 权限（Authz）与降级路径
- **人员详情页查看**：`person.persons view`
- **任职维护**：需要 `org.assignments assign`（或等价权限）
  - 若用户可查看人员但无任职维护权限：仍可查看时间线，但不展示“新增/编辑/调动/结束任职”等动作入口。
- **无权限页 Debug 信息**：仅对具备 `Authz Debug` 权限的用户展示调试区块。

### 7.2 多语言与文案
- 状态、按钮、提示语进入 locales（避免硬编码英文状态）。
- “截断上一条任职结束日”的提示文案需明确且可本地化。

### 7.3 可用性（UX）与防错
- 任职表单遵循“先部门后职位”的强引导：未选择部门时，职位 combobox 禁用并提示“请先选择部门”。
- 提交前提示影响面：显示“本次变更将从 {effective_date} 生效，并结束上一条任职至 {effective_date}”。

## 8. 未授权页（Permission required）体验改造
- 面向业务用户的默认文案：说明“为什么看不到/下一步怎么做”。
- 申请权限流程：保留“申请访问”与状态（如 awaiting review + SLA），并提供“查看申请”入口。
- Debug 信息隔离：`policy diff / base revision / inspector` 仅对管理员或显式 Debug 模式展示。

## 9. 实施步骤（待办）
1. [ ]（后续）明确 HR 高频字段清单与口径（状态枚举、日期展示、字段中文名）
2. [x] 补齐人员详情接口/查询：返回组织与职位的可读信息（名称/编码），避免 UI 直出 UUID
3. [ ]（后续）调整 `.templ` 页面结构：面包屑、概览卡、Tabs、任职列表列与动作
4. [x] 创建人员流程补齐初始部门/职位：向导/单页方案择一落地，并复用 Org 任职表单能力
5. [x] 任职维护表单体验：职位改为可搜索选择（按部门/生效日过滤），并修复“当天生效不可编辑”
6. [x] 更新多语言资源：状态/标签/按钮文案
7. [x] 改造无权限页：业务版默认 + Debug 隔离
8. [x] 回归验收：创建人员→补齐初始任职→部门选“房地产”→职位候选按部门过滤→保存→详情页展示名称且无 UUID 直出
9. [x] 门禁记录：按 `AGENTS.md` 触发器矩阵执行并记录结果（带时间戳）

### 9.1 本地验证记录（可复现）
> 记录口径：只记“入口命令 + 结果”，细节以 `Makefile`/CI 为准。

- 2025-12-23 18:52 UTC：`make generate && make css && make check tr` ✅
- 2025-12-23 18:52 UTC：`go fmt ./... && go vet ./... && make check lint && make test` ✅
- 2025-12-23 18:52 UTC：`make authz-test && make authz-lint` ✅
- 2025-12-23 18:52 UTC：`make e2e ci` ✅（覆盖：创建 061001 → 选“房地产” → 选该部门有效职位 → 保存成功）
- 2025-12-23 18:52 UTC：`make check doc` ✅

## 10. 风险与回滚
- **风险：跨模块依赖变更**（扩展 `/org/positions/search`）
  - 缓解：保持向后兼容；不传 `org_node_id` 时维持旧行为或返回空，避免破坏既有调用方。
- **风险：展示聚合性能**（详情页需要 label）
  - 缓解：优先使用批量查询/缓存（如存在），避免逐行 N+1。
- **回滚策略**：保留旧字段展示逻辑为兜底（feature flag 或快速 revert commit），确保不影响核心 CRUD。

## 11. 交付物
- [x] 更新后的人员详情页（创建后强引导补齐部门/职位；任职时间线可读性增强；UUID 不直出）
- [x] 更新后的无权限页（面向业务用户；Debug 信息隔离）
- [x] 对应的多语言资源与 e2e 用例（persons 侧覆盖创建与任职选择）

## 12. 待决事项与关闭条件
- **待决事项（已收敛）**：无。本计划内未完成项已明确标注为“后续”，不阻塞本计划关闭。
- **关闭条件**：
  - [x] `make generate && make css` 且生成物已提交（`git status --short` 无未提交生成物）
  - [x] `make check tr`
  - [x] `go fmt ./... && go vet ./... && make check lint && make test`
  - [x] e2e：`make e2e ci`（至少覆盖 persons 相关用例）
  - [x] 手工验收：在 UI 将人员 `061001` 的部门设置为“房地产”，职位选择该部门下有效职位，保存成功；详情页不直出 UUID；创建人员后可被引导补齐部门/职位
