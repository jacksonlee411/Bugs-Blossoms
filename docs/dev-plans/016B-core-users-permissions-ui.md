# DEV-PLAN-016B：Core 用户权限页签 UI 与操作交互优化（基于 016A 的增量迭代）

**状态**: 草拟中（2025-12-15 00:30 UTC）

## 1. 背景与上下文 (Context)
- DEV-PLAN-016A 已完成“权限页签”的信息架构与主交互闭环（Tab 分屏、全局筛选条、Sources 抽屉、AuthzWorkspace 暂存区等）。
- 本计划（016B）面向“可理解性、可发现性、防误操作、可访问性（a11y）与一致性”做增量优化，不改变既有鉴权语义与后端接口。

## 2. 现状操作说明（作为本次优化输入）
> 本节是对当前“用户 → 编辑 → 权限”页签的操作说明与交互契约梳理，作为后续 UI/交互优化的输入基线。

### 2.1 顶部信息区（Meta）
- 标题为「权限」。
- 展示并可复制：
  - **主体（Subject）**：用户在 authz 中的 subject；显示为短格式，`title` 悬停可看完整值。
  - **域（Domain）**：默认域；同样可复制。
- 右上角主操作区域（依权限而变）：
  - `CanStage=true`：显示「创建」下拉，可新增「直接权限 / 覆盖权限」。
  - `CanStage=false && CanRequest=true`：显示「申请权限」（提交 `request_access`）。
  - `CanStage=false && CanRequest=false`：仅提示“无权限”。

### 2.2 顶部全局筛选条（Domain + Search + Clear）
- **Domain 输入框**：作为当前查看/计算的域上下文；空值会回落到默认域。
- **Search 输入框**：作为关键字过滤（`q`）。
- **Clear**：清空筛选并 push URL 回到 base 状态。
- 交互：筛选项 change/keyup 触发 `GET /users/{id}/policies` 刷新整个 `#user-policy-board`。

### 2.3 SLA/请求状态区（提交后轮询）
- 提交草稿后，显示状态标签并轮询 `GET /core/api/authz/requests`：
  - 状态：待审批/待部署/已生效/失败/已拒绝/已取消/草稿等。
  - 超时后提示：可重试查询、复制 `request_id`。

### 2.4 二级 Tab：Effective / Direct / Overrides / Inherited
- **有效权限汇总（Effective）**
  - 表格列：Domain / Object / Action / Effect / 来源。
  - 「来源」摘要：
    - 「用户直配」：该条权限来自用户自身（p 规则）。
    - 「N 角色」：该条权限也来自 N 个角色链路。
  - 放大镜按钮打开「来源」抽屉：展示 Direct 与角色链路；可跳转「查看角色策略」（新窗口，需具备查看角色权限）。
- **直接权限（Direct）**
  - 显示用户在默认域内的直接策略（p 规则）。
  - 单条撤销通过“暂存撤销”实现：点击「删除」会把该规则加入暂存（而非立即生效）。
  - 支持批量撤销：勾选 → 「批量撤销」→ 生成暂存撤销；支持 Undo。
- **覆盖权限（Overrides）**
  - 用于默认域之外的策略查看/编辑；通常与 Domain 输入框配合切换目标域。
  - 新增/撤销同样进入暂存。
- **继承权限（Inherited）**
  - 只读：来源于角色/组分配形成的继承关系（g 规则视图）。
  - 提示“需在用户信息里调整角色/组，并在有效权限汇总确认最终生效”。

### 2.5 新增规则（通过「创建」下拉打开抽屉）
- 抽屉表单字段：
  - Domain（域）
  - Effect（allow/deny；deny 属危险项，会在提交前预览提示）
  - Object / Action（带 datalist 候选）
- 保存后进入暂存（stage），不会立即生效。

### 2.6 暂存区（AuthzWorkspace Sticky Footer）
- 出现条件：存在暂存变更（`staged_count > 0`）。
- 展示：Subject@Domain、暂存条数与（+新增 / -撤销）摘要。
- **Reason 必填**。
- 操作：
  - 「丢弃草稿」：清空暂存。
  - 「提交草稿」：二次确认后提交；确认弹窗包含变更预览与危险项提示（deny / 通配符 / 多域）。

## 3. 当前问题与优化机会（待确认）
1. “覆盖权限”概念对非技术用户不够直观，Domain 输入与 Overrides 的关系需要更强的引导与可视化。
2. 表格内「删除」语义容易被理解为“立即删除/立即生效”，而实际上是“暂存撤销”；需要更明确的文案/视觉与操作反馈。
3. 暂存/提交/轮询/最终生效链路虽可用，但“我改了什么、现在卡在哪一步”仍需要更强的状态可见性（尤其是多次提交/多请求并存场景）。
4. 可发现性细节：
   - Effective 的 Sources 抽屉入口（放大镜）需要更明确的可点击提示与键盘可达性。
   - Inherited 只读边界需要更强的“去哪里改”引导（含跳转到用户信息 Tab 的建议路径）。
5. a11y 与一致性：
   - Drawer/Tab/表格操作的键盘交互、ARIA label、焦点管理与 live region（状态提示）需系统化回归。

### 3.1 外部建议的采纳决策（本计划范围内）
> 结论：优先采纳“低风险/高收益”的信息提示、微交互与可行动性；需要新增语义/接口或大改 IA 的建议延期到后续计划。

- A. Domain 心智模型与联动
  - **采纳**：Tab 弱提示（Direct=默认域、Overrides=非默认域）、筛选条的“当前域/默认域”提示与说明文案。
  - **部分采纳**：不做“自动切换 Tab”，改为“非阻断提示 + 一键跳转”（避免强制改变用户上下文）。
  - **延期**：合并 Direct/Overrides 为单一 Tab（属于 IA 重构，需单独评审与用户测试）。
- B. “暂存撤销”微交互
  - **采纳**：撤销动作不移除行、用行样式/标签明确“待移除”，并把按钮语义从「删除」收敛到“暂存撤销/撤销暂存”。
  - **采纳**：底部暂存栏摘要与表格内状态用同一术语与颜色体系（+新增/-撤销）。
- C. Inherited 可行动性
  - **采纳**：在 Inherited Tab 顶部增加 CTA，指向“用户信息 > 角色/组分配”，形成闭环路径。
  - **部分采纳**：在不新增 API 的前提下，尽量提供“来源角色/跳转角色策略”的入口；链路级溯源若缺数据则延期。
- D. Effective 钻取体验
  - **采纳**：来源摘要由 “N 角色”增强为 tags（直配/角色名/更多），提升可读性与可点击性。
  - **延期**：在 Effective 中引入 deny 优先级/“决定性规则”解释（需要扩展当前 Effective 语义与计算方式）。
- E. 提交反馈与 SLA 可视化
  - **采纳**：SLA 区域改为步骤条/时间轴式呈现，强化“当前在哪一步”的可见性。
  - **延期**：失败请求“恢复草稿/回填暂存区”（通常需要可回放 diff 的稳定契约或新增接口）。

## 4. 目标与非目标 (Goals & Non-Goals)
### 4.1 目标
- [ ] 强化 Domain/Overrides 的心智模型：让用户在不懂 Casbin 的情况下也能理解“默认域/当前域/跨域覆盖”的关系。
- [ ] 降低误操作：将“删除=暂存撤销”表达得更明确，并在批量操作中给出清晰的范围反馈。
- [ ] 提升可见性：让用户能快速回答“哪些变更已暂存/已提交/已生效/失败原因是什么”。
- [ ] a11y 复验并补齐可回归清单（对齐 DEV-PLAN-016A 与 015B 系列标准）。

### 4.2 非目标
- 不改变策略语义（p/g）、不引入新权限模型。
- 不新增后端 API（优先在现有 `/users/{id}/policies`、`/core/api/authz/*` 上做 UI/交互增强）。
- 不改变 Effective 的语义范围：本计划默认 Effective 仍以当前实现为准（不在此引入 deny 优先级解释器）。
- 不调整冻结模块：`modules/billing`、`modules/crm`、`modules/finance`。

## 5. 设计提案（交互与 UI）
> 本节为待落地的设计方向（以 016A 现有 IA 为基线），实施前需补齐高保真稿/组件拆分与验收准则。

### 5.1 Domain 心智模型（弱提示 + 非阻断联动）
- Tab 弱提示：
  - Direct：显示弱标记「默认域」。
  - Overrides：显示弱标记「非默认域」。
- 筛选条提示：
  - 明确显示“默认域：{DefaultDomain}”。
  - 当用户输入非默认域时，给出非阻断提示：“当前域为非默认域，相关策略通常在 Overrides 查看”，并提供“一键切换到 Overrides”的按钮（不自动切换）。

### 5.2 撤销语义收敛（从“删除”到“暂存撤销”）
- 单条撤销（Direct/Overrides）：
  - 行不消失；以淡红背景 + 删除线 + 标签明确“待移除（暂存撤销）”。
  - 操作按钮从「删除」改为更贴近事实的语义：
    - 未暂存：`暂存撤销`
    - 已暂存撤销：`撤销暂存`（等价于删除 stage 条目）
- 批量撤销：
  - 按钮显示数量：`批量撤销（{selectedCount}）`。
  - Undo 提示包含范围与数量（Direct/Overrides + count），避免用户误解为全局撤销。
- 底部暂存栏联动：
  - 摘要明确展示“新增 X / 拟删除 Y”，并与表格标签使用同一术语。

### 5.3 Inherited 的可行动性（避免“死胡同”）
- 在 Inherited Tab 顶部提示区增加 CTA：
  - 文案：“继承权限来自角色/组。如需调整，请前往 用户信息 → 角色/组分配。”
  - 行为：点击后切换到用户信息 Tab 并聚焦到角色/组区域（若实现成本过高，至少切 Tab）。
- 在 Inherited 表格中增强“去哪里看来源”的路径：
  - 对 g 规则优先提供“查看角色策略”的跳转入口（若可解析角色）。
  - “链路级溯源”若缺少数据来源，明确标注为后续计划项。

### 5.4 Effective 的可扫描性与钻取
- 来源摘要从 “N 角色” 增强为 tags：
  - 示例：`[用户直配] [管理员] [+2]`（只展示前 1-2 个角色名，其余折叠为 +N）。
- 放大镜按钮增加可发现性：
  - tooltip 文案统一、hover/focus 明显、aria-label 明确。

### 5.5 SLA 区域的“步骤可视化”
- 将状态标签呈现为步骤条/时间轴（不改变轮询逻辑）：
  - `提交草稿 -> 待审批 -> 待部署 -> 已生效`（失败/拒绝/取消作为终止态分支）
- 保留“预计 ≤5 分钟回写”，并在轮询中展示最近 request_id（可复制）。

### 5.6 a11y 回归与一致性
- Tab：键盘导航、焦点可见、ARIA role 与选中态一致。
- Drawer：打开后焦点落点、Esc 关闭、关闭后回到触发点。
- 表格：所有图标按钮具备明确 aria-label；状态提示使用 `aria-live="polite"`（避免打断）。

## 6. 验收标准 (Acceptance Criteria)
- 用户在不理解 Casbin 的前提下能通过 UI 明确区分：默认域下的直接权限、跨域覆盖、以及继承权限（只读）。
- 当用户输入非默认域时，界面会明确提示其含义，并提供一键跳转到合适的 Tab（不强制自动切换）。
- 表格内撤销动作不会被误解为“立即删除/立即生效”：行会呈现“待移除（暂存撤销）”的可见状态，且提供“撤销暂存”的反向操作。
- 批量撤销/Undo 的作用范围、数量与结果可感知且不产生歧义。
- Inherited Tab 提供可点击的“去哪里改”入口，用户能在 1-2 次点击内回到角色/组分配处继续操作。
- Effective 的来源摘要可扫描（tags），且来源抽屉入口可发现且可键盘触达。
- SLA 状态在界面上以步骤方式呈现，用户能明确知道当前阶段与终止态。
- 关键交互满足基础 a11y：Tab/Drawer/按钮可键盘访问且焦点管理正确。

## 7. 实施步骤（待办）
> 建议按 P0/P1/P2 分阶段交付，保证每一阶段都可独立验收。

### P0（优先：低风险/高收益/不改语义）
1. [ ] 文案与 i18n key 规划：把“删除/暂存撤销/撤销暂存/待移除/默认域/非默认域”等术语定稿并对齐四语种。
2. [ ] Domain 心智模型弱提示：Tab 徽标 + 筛选条“默认域/当前域”提示 + 一键跳转提示（不自动切 Tab）。
3. [ ] 撤销语义收敛：表格动作改名与状态标签统一；批量撤销按钮展示选中数量；Undo 提示补充范围。
4. [ ] Effective 来源摘要 tags 化：替换 “N 角色” 的单一摘要为可扫描 tags（不改变抽屉内容与计算逻辑）。
5. [ ] SLA 步骤可视化：将状态标签改为步骤条/时间轴，并展示最近 request_id（可复制）。

### P1（增强：闭环引导/可发现性）
1. [ ] Inherited CTA：提供“去用户信息改角色/组”的可点击入口（至少切 Tab）。
2. [ ] 可发现性增强：放大镜入口 tooltip/焦点样式统一；关键图标按钮补齐 aria-label。

### P2（质量：a11y 与回归记录）
1. [ ] a11y 回归记录：Tab/Drawer/表格/提示区的键盘巡检与焦点管理记录。
2. [ ] 门禁回归：`make check doc`（若涉及模板/资源则补齐 `make generate && make css`）。

## 8. 参考
- `docs/dev-plans/016A-core-users-permissions-ia.md`
- `docs/dev-plans/016-authz-ui-optimizations.md`
