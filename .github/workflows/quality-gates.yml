name: Quality Gates

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  lint-and-format:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    name: Code Quality & Formatting
    services:
      postgres:
        image: postgres:17
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: iota_erp
        options: >-
          --health-cmd="pg_isready -U postgres -d iota_erp"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changed-files
        uses: dorny/paths-filter@v3
        with:
          filters: |
            templ:
              - '**/*.templ'
              - 'tailwind.config.js'
              - 'modules/**/presentation/assets/**'
            locales:
              - 'modules/**/presentation/locales/**/*.json'
            schema:
              - 'migrations/**'
              - 'modules/**/infrastructure/persistence/schema/**'
            go:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - '.gocleanarch.yml'
            hrm-sqlc:
              - 'sqlc.yaml'
              - 'modules/hrm/infrastructure/sqlc/**'
              - 'modules/hrm/infrastructure/persistence/**/*.sql'
              - 'scripts/db/export_hrm_schema.sh'
              - 'docs/dev-records/hrm-sql-inventory.md'
            hrm-atlas:
              - 'atlas.hcl'
              - 'modules/hrm/infrastructure/atlas/**'
              - 'migrations/hrm/**'
              - 'scripts/db/run_goose.sh'
              - 'scripts/db/export_hrm_schema.sh'
              - 'docs/dev-records/DEV-PLAN-011-HRM-ATLAS-POC.md'
            authz:
              - 'pkg/authz/**'
              - 'cmd/authzbot/**'
              - 'scripts/authz/**'
              - 'config/access/**'
              - 'modules/core/services/**'
              - 'modules/core/presentation/controllers/**'

      - name: Set up Go
        uses: useblacksmith/setup-go@v6
        with:
          go-version: "1.24.10"

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v2.1.3
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          golangci-lint version

      - name: Install templ
        run: |
          go install github.com/a-h/templ/cmd/templ@v0.3.857
          templ --help

      - name: Install TailwindCSS
        run: |
          echo "Installing TailwindCSS for x64 architecture..."
          mkdir -p downloaded
          curl -sL -o downloaded/tailwindcss https://github.com/tailwindlabs/tailwindcss/releases/download/v3.4.13/tailwindcss-linux-x64
          chmod +x downloaded/tailwindcss
          echo "$PWD/downloaded" >> $GITHUB_PATH

      - name: Install pg_formatter for SQL formatting
        run: |
          sudo apt-get update
          sudo apt-get install -y pgformatter

      - name: Download Go dependencies
        run: go mod download

      - name: Install Atlas CLI
        if: ${{ steps.changed-files.outputs.hrm-atlas == 'true' }}
        run: make atlas-install

      - name: Regenerate templ artifacts
        if: ${{ steps.changed-files.outputs.templ == 'true' }}
        run: make generate

      - name: Ensure templ artifacts are committed
        if: ${{ steps.changed-files.outputs.templ == 'true' }}
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Detected generated files that are not committed"
            git status --short
            exit 1
          fi

      - name: Check translation files
        if: ${{ steps.changed-files.outputs.locales == 'true' }}
        run: make check tr

      - name: Check templ files formatting
        run: |
          templ fmt .
          if [ -n "$(git diff --name-only)" ]; then
            echo "Error: Some templ files are not properly formatted"
            git diff
            exit 1
          fi
          echo "All templ files are properly formatted"

      - name: Check Go files formatting
        run: |
          set -euo pipefail
          packages="$(./scripts/go-active-packages.sh | tr '\n' ' ')"
          if [ -n "$packages" ]; then
            go fmt $packages
          else
            echo "No active Go packages to format"
          fi
          diff_files="$(git diff --name-only)"
          if [ -n "$diff_files" ]; then
            filtered="$(echo "$diff_files" | grep -Ev '^modules/(billing|crm|finance)/' || true)"
            if [ -n "$filtered" ]; then
              echo "Error: Some Go files are not properly formatted"
              git diff
              exit 1
            fi
          fi
          echo "All Go files are properly formatted"

      - name: Check SQL files formatting
        run: |
          mkdir -p /tmp/formatted
          find modules -name "*.sql" -type f | while read -r sqlfile; do
            if [[ "$sqlfile" =~ ^modules/(billing|crm|finance)/ ]]; then
              continue
            fi
            pg_format "$sqlfile" > "/tmp/formatted/$(basename "$sqlfile")"
            if ! diff -q "$sqlfile" "/tmp/formatted/$(basename "$sqlfile")" > /dev/null; then
              echo "Error: $sqlfile is not properly formatted"
              diff "$sqlfile" "/tmp/formatted/$(basename "$sqlfile")"
              exit 1
            fi
          done
          echo "All SQL files are properly formatted"

      - name: Run HRM sqlc generate
        if: ${{ steps.changed-files.outputs.hrm-sqlc == 'true' }}
        run: make sqlc-generate

      - name: Ensure sqlc artifacts are committed
        if: ${{ steps.changed-files.outputs.hrm-sqlc == 'true' }}
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Detected sqlc artifacts that are not committed"
            git status --short
            exit 1
          fi

      - name: Run go vet
        run: |
          set -euo pipefail
          packages="$(./scripts/go-active-packages.sh | tr '\n' ' ')"
          if [ -z "$packages" ]; then
            echo "No active Go packages to vet"
            exit 0
          fi
          go vet $packages

      - name: Generate CSS files
        if: ${{ steps.changed-files.outputs.templ == 'true' }}
        run: make css

      - name: Run golangci-lint (unused variables/functions + go-cleanarch)
        if: ${{ steps.changed-files.outputs.go == 'true' }}
        run: make check lint

      - name: Run authz suites
        if: ${{ steps.changed-files.outputs.authz == 'true' }}
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: iota_erp
        run: |
          make authz-test
          make authz-lint
          go test ./cmd/authzbot
          go test ./modules/core/services
          go test ./modules/core/presentation/controllers

      - name: Run HRM Atlas plan
        if: ${{ steps.changed-files.outputs.hrm-atlas == 'true' }}
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: iota_erp
          HRM_MIGRATIONS: "1"
        run: make db plan

      - name: Run HRM Atlas lint
        if: ${{ steps.changed-files.outputs.hrm-atlas == 'true' }}
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: iota_erp
        run: make db lint

      - name: Ensure atlas artifacts are committed
        if: ${{ steps.changed-files.outputs.hrm-atlas == 'true' }}
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Atlas/goose commands produced uncommitted changes"
            git status --short
            exit 1
          fi

  test-unit-integration:
    runs-on: ubuntu-latest
    name: Unit & Integration Tests

    services:
      postgres:
        image: postgres:17
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: iota_erp
          POSTGRES_INITDB_ARGS: "-c max_connections=1000 -c shared_buffers=2GB \
                                 -c effective_cache_size=6GB -c maintenance_work_mem=512MB \
                                 -c work_mem=32MB -c fsync=off -c synchronous_commit=off \
                                 -c full_page_writes=off -c wal_buffers=64MB \
                                 -c max_wal_size=4GB -c min_wal_size=1GB \
                                 -c checkpoint_completion_target=0.9 -c wal_compression=on \
                                 -c random_page_cost=1.0 -c seq_page_cost=1.0 \
                                 -c cpu_tuple_cost=0.01 -c cpu_index_tuple_cost=0.001 \
                                 -c cpu_operator_cost=0.0005 -c log_min_duration_statement=0 \
                                 -c log_statement=none -c log_checkpoints=off \
                                 -c log_connections=off -c log_disconnections=off \
                                 -c autovacuum=off -c track_activities=off \
                                 -c track_counts=off -c jit=off -c huge_pages=try \
                                 -c temp_buffers=128MB -c max_prepared_transactions=0 \
                                 -c bgwriter_delay=10000ms -c bgwriter_lru_maxpages=0 \
                                 -c effective_io_concurrency=200 -c maintenance_io_concurrency=200 \
                                 -c max_parallel_workers_per_gather=4 -c max_parallel_workers=8 \
                                 -c max_parallel_maintenance_workers=4 -c default_statistics_target=10 \
                                 -c enable_partitionwise_join=on -c enable_partitionwise_aggregate=on"
        options: >-
          --tmpfs /var/lib/postgresql/data:rw,size=6g,noatime
          --health-cmd="pg_isready -U postgres -d iota_erp"
          --health-interval=5s --health-timeout=5s --health-retries=5
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --tmpfs /data:rw,size=6g

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect file changes
        id: changed-files
        uses: dorny/paths-filter@v3
        with:
          filters: |
            templ:
              - '**/*.templ'
              - 'tailwind.config.js'
              - 'modules/**/presentation/assets/**'
            locales:
              - 'modules/**/presentation/locales/**/*.json'
            schema:
              - 'migrations/**'
              - 'modules/**/infrastructure/persistence/schema/**'
            go:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - '.gocleanarch.yml'

      - name: Set up Go
        uses: useblacksmith/setup-go@v6
        with:
          go-version: "1.24.10"

      - name: Install templ
        run: |
          go install github.com/a-h/templ/cmd/templ@v0.3.857
          templ --help

      - name: Install TailwindCSS
        run: |
          echo "Installing TailwindCSS for x64 architecture..."
          mkdir -p downloaded
          curl -sL -o downloaded/tailwindcss https://github.com/tailwindlabs/tailwindcss/releases/download/v3.4.13/tailwindcss-linux-x64
          chmod +x downloaded/tailwindcss
          echo "$PWD/downloaded" >> $GITHUB_PATH

      - name: Download Go dependencies
        run: go mod download

      - name: Wait for PostgreSQL to be ready
        run: |
          until pg_isready -h localhost -p 5432 -U postgres -d iota_erp; do
            echo "Waiting for postgres..."
            sleep 1
          done

      - name: Initialize migration log
        run: |
          : > migrate.log

      - name: Prepare database schema (no schema diffs)
        if: ${{ steps.changed-files.outputs.schema != 'true' }}
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: iota_erp
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: |
          set -euo pipefail
          make db migrate up 2>&1 | tee -a migrate.log
          make db seed 2>&1 | tee -a migrate.log

      - name: Validate migrations when schema changes
        if: ${{ steps.changed-files.outputs.schema == 'true' }}
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: iota_erp
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: |
          set -euo pipefail
          make db migrate up 2>&1 | tee -a migrate.log
          make db migrate up 2>&1 | tee -a migrate.log
          make db seed 2>&1 | tee -a migrate.log
          make db seed 2>&1 | tee -a migrate.log

      - name: Run tests with coverage
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: iota_erp
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: ./scripts/run-go-tests.sh -coverprofile=coverage.out -covermode=atomic

      - name: Generate coverage report
        env:
          COVERAGE_THRESHOLD: 10
          COVERAGE_MAX_FILES_DISPLAY: 100
          COVERAGE_IGNORE_PATTERNS: "cmd/,*_templ.go,viewmodels/"
        run: node ./.github/scripts/coverage-report.js --file coverage.out --output github

      - name: Generate HTML coverage report
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Smoke migrate down
        if: ${{ steps.changed-files.outputs.schema == 'true' }}
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: iota_erp
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: |
          set -euo pipefail
          make db migrate down 2>&1 | tee -a migrate.log

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage
          path: |
            coverage.out
            coverage.html
            migrate.log

  test-e2e:
    runs-on: ubuntu-latest
    name: E2E Tests

    services:
      postgres:
        image: postgres:17
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: iota_erp_e2e
          POSTGRES_INITDB_ARGS: "-c max_connections=1000 -c shared_buffers=2GB \
                                 -c effective_cache_size=6GB -c maintenance_work_mem=512MB \
                                 -c work_mem=32MB -c fsync=off -c synchronous_commit=off \
                                 -c full_page_writes=off -c wal_buffers=64MB \
                                 -c max_wal_size=4GB -c min_wal_size=1GB \
                                 -c checkpoint_completion_target=0.9 -c wal_compression=on \
                                 -c random_page_cost=1.0 -c seq_page_cost=1.0 \
                                 -c cpu_tuple_cost=0.01 -c cpu_index_tuple_cost=0.001 \
                                 -c cpu_operator_cost=0.0005 -c log_min_duration_statement=0 \
                                 -c log_statement=none -c log_checkpoints=off \
                                 -c log_connections=off -c log_disconnections=off \
                                 -c autovacuum=off -c track_activities=off \
                                 -c track_counts=off -c jit=off -c huge_pages=try \
                                 -c temp_buffers=128MB -c max_prepared_transactions=0 \
                                 -c bgwriter_delay=10000ms -c bgwriter_lru_maxpages=0 \
                                 -c effective_io_concurrency=200 -c maintenance_io_concurrency=200 \
                                 -c max_parallel_workers_per_gather=4 -c max_parallel_workers=8 \
                                 -c max_parallel_maintenance_workers=4 -c default_statistics_target=10 \
                                 -c enable_partitionwise_join=on -c enable_partitionwise_aggregate=on"
        options: >-
          --tmpfs /var/lib/postgresql/data:rw,size=6g,noatime
          --health-cmd="pg_isready -U postgres -d iota_erp_e2e"
          --health-interval=5s --health-timeout=5s --health-retries=5
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --tmpfs /data:rw,size=6g

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: useblacksmith/setup-go@v6
        with:
          go-version: "1.24.10"

      - name: Install templ
        run: |
          go install github.com/a-h/templ/cmd/templ@v0.3.857
          templ --help

      - name: Install TailwindCSS
        run: |
          echo "Installing TailwindCSS for x64 architecture..."
          mkdir -p downloaded
          curl -sL -o downloaded/tailwindcss https://github.com/tailwindlabs/tailwindcss/releases/download/v3.4.13/tailwindcss-linux-x64
          chmod +x downloaded/tailwindcss
          echo "$PWD/downloaded" >> $GITHUB_PATH

      - name: Download Go dependencies
        run: go mod download

      - name: Generate CSS files
        run: make css

      - name: Setup E2E database
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: |
          make e2e reset

      - name: Install PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Node dependencies
        run: pnpm install
        working-directory: e2e

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium
        working-directory: e2e

      - name: Start Go Server
        env:
          SESSION_DURATION: 720h
          DOMAIN: localhost
          PORT: 3201
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: iota_erp_e2e
          DB_USER: postgres
          DB_PASSWORD: postgres
          SID_COOKIE_KEY: sid
          GO_APP_ENV: development
          ENABLE_TEST_ENDPOINTS: true
        run: |
          go run cmd/server/main.go &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

          # Wait for server to be ready (timeout: 60 seconds)
          timeout 60 bash -c 'until curl -s http://localhost:3201 > /dev/null; do sleep 1; done'

      - name: Run Playwright Tests
        env:
          BASE_URL: http://localhost:3201
        run: npx playwright test
        working-directory: e2e

      - name: Stop Go Server
        if: always()
        run: kill ${{ env.SERVER_PID }} || true

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 30

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: e2e/test-results/
          retention-days: 30
